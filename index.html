
<html>
    <head>
        <script
            src="https://code.jquery.com/jquery-3.5.1.js"
            integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
            crossorigin="anonymous">
        </script>
        <script src="https://cdn.jsdelivr.net/npm/webmidi"></script>

    </head>
       <body>
        <h1>Exit Points experimental clock</h1>
        <br>
        The app is hosted on a free cloud instance, so it is configured to stop running if it doesn't receive a ping from this webpage after 30 minutes. 
        <br>
        So: if the clock doesn't run when you first connect, wait a few seconds and try refreshing the page. 
        <br>
        Message @michael palumbo on the Exit Points Discord if there's any problems. 
        <br>
        Contribute to development at <a href="https://github.com/exitpoints/ws" target="_blank">exitpoints/ws</a>
        <br>
        <br>
        Note: at the moment, this page receives both beat and MIDI timing messages from a central server, <br>but still needs to be configured to transmit this data locally on a MIDI channel, or over UDP via OSC. :)
        <br>
        <br>
        <br>
        <div class="col-md-5 mt-4 mx-auto">
            <label for="bpm" class="text-capitalize">BPM:</label>
            <input id="bpm" type="text" class="number">
          </div>

        <br>
        Beat: <div id="beat" style = "display: inline-block">1</div>/<div id="bpb" style="display: inline-block">4</div>
        <br>
        MIDI Timing 11111000 (Client-side) <div id="MIDITiming"></div>

        <br>
        <br>
        <!-- <div class="dropdown">
            <button class="dropbtn">MIDI Output</button>
            <div class="dropdown-content" id="MIDIOutputSelector">

            </div>
          </div> -->
        Set device to receive MIDI clock from this page
        <br>
        <select id="MIDIOutputSelector">
			<option value="None">-- Select Output --</option>
			
        </select>
        <br><br>
        Select Not ready yet<br>
        <select id="MIDIInputSelector">
			<option value="None">-- Select Input --</option>
			
        </select>
    

    </body>




<script>
//! OSC/UDP is a pain in the browser...
// const osc = new OSC({ plugin: new OSC.DatagramPlugin() })
// osc.open({ port: 9912 })

// // send only this message to `localhost:9002`
// osc.send(new OSC.Message('/test'), { port: 9002 })

// navigator.requestMIDIAccess()
//     .then(onMIDISuccess, onMIDIFailure);

// function onMIDISuccess(midiAccess) {
//     console.log(midiAccess);

//     var inputs = midiAccess.inputs;
//     var outputs = midiAccess.outputs;
// }

// function onMIDIFailure() {
//     console.log('Could not access your MIDI devices.');
// }


let midiOutput = null;
let midiInput = null;
let outputs
let inputs
let manufacturer = null

// let outputs = []
//     navigator.requestMIDIAccess()
//     .then(function(midiAccess) {
//         outputs = Array.from(midiAccess.outputs.values());
//     // console.log(outputs);



//     for(i =0; i< outputs.length; i++){
//         $('#MIDIOutputSelector').append('<option id="' + i + '">' + outputs[i].name + '</option>');
//     }
// });
    // midiOutput.send([0b10000000, 0b00011100, 01111111]); // binary
$("#MIDIOutputSelector").change(function() {
    var id = $(this).find('option:selected').attr('id');

    // var id = $(this).children(":selected").attr("id");
    console.log('MIDI Output set to: ', outputs[id].name)
    midiOutput = outputs[id]
    if (outputs[id].manufacturer){
        manufacturer = outputs[id].manufacturer
        console.log(manufacturer)
    }
    // midiOutput.playNote("C3");
    midiOutput.sendClock();
    // midiOutput.send([250])
    
});

$("#MIDIInputSelector").change(function() {
    var id = $(this).find('option:selected').attr('id');

    // var id = $(this).children(":selected").attr("id");
    console.log('MIDI Input set to: ', inputs[id].name)
    midiInput = inputs[id]
    // midiInput.playNote("C3");
    // midiOutput.send([250])
    midiInput.addListener('gate', "all", function(e) {
    console.log("gate value: " + e.value);
});
});



const url = 'wss://exitpoints.herokuapp.com/8081'
const connection = new WebSocket(url)

connection.onopen = () => {
//   connection.send('hey')
}

let MIDITimingCount = 0
connection.onmessage = e => {
    let msg = JSON.parse(e.data)
    switch (msg.cmd){
        case "beat":
        document.getElementById("beat").innerHTML = msg.data
        // beat.textContent = msg.data
        if(midiOutput){
                // midiOutput.send([0x90, 0x3C, 0x80])
            }
        // $("beat").update(msg.data);
        //console.log(msg.data)
        break;
        case "MIDI_Timing":
            document.getElementById("MIDITiming").innerHTML = MIDITimingCount++
            if(midiOutput){
                // midiOutput.send([248, 0, 0])
            }
        break
        case "bpm":
            document.getElementById("bpm").value = msg.data
            console.log(msg.data)
            
        break
    }
}


// BPM entry
    $(document).ready(function () {

    $('input.number').keyup(function (event) {
    if (event.which != 8 && event.which != 0 && event.which < 48 || event.which > 57) {
        $(this).val(function (index, value) {
        bpm = document.getElementById('bpm').value
        if (bpm <= 2){
            alert('cannot accept a bpm that fast')
            return
        }
        let msg = JSON.stringify({
            cmd: 'bpm',
            data: bpm
        })
        connection.send(msg)

        return value.replace(/\D/g, "");
        });
    }

    });
    });


    
WebMidi.enable(function (err) {

    if (err) {
    console.log("WebMidi could not be enabled.", err);
    } else {
        console.log("WebMidi enabled!");
        console.log(WebMidi.inputs);
        console.log(WebMidi.outputs);
        outputs = WebMidi.outputs
        inputs = WebMidi.inputs
        for(i =0; i< outputs.length; i++){
            $('#MIDIOutputSelector').append('<option id="' + i + '">' + outputs[i].name + '</option>');
        }
        for(i =0; i< inputs.length; i++){
            $('#MIDIInputSelector').append('<option id="' + i + '">' + inputs[i].name + '</option>');
        }
    }

    }, true);



</script>


</html>