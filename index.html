<html>
    <head>
        <script
            src="https://code.jquery.com/jquery-3.5.1.js"
            integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
            crossorigin="anonymous">
        </script>
    </head>
    <body>
        <h1>Exit Points experimental clock</h1>
        <br>
        The app is hosted on a free cloud instance, so it is configured to stop running if it doesn't receive a ping from this webpage after 30 minutes. 
        <br>
        So: if the clock doesn't run when you first connect, wait a few seconds and try refreshing the page. 
        <br>
        Message @michael palumbo on the Exit Points Discord if there's any problems. 
        <br>
        Contribute to development at <a href="https://github.com/exitpoints/ws" target="_blank">exitpoints/ws</a>
        <br>
        <br>
        Note: at the moment, this page receives both beat and MIDI timing messages from a central server, <br>but still needs to be configured to transmit this data locally on a MIDI channel, or over UDP via OSC. :)
        <br>
        <br>
        <br>
        BPM: <div id="bpm" style = "display: inline-block"></div>
        Beat: <div id="beat" style = "display: inline-block">1</div>/<div id="bpb" style="display: inline-block">4</div>
        <br>
        MIDI Timing 11111000 (Client-side) <div id="MIDITiming"></div>

    </body>




<script>

// navigator.requestMIDIAccess()
//     .then(onMIDISuccess, onMIDIFailure);

// function onMIDISuccess(midiAccess) {
//     console.log(midiAccess);

//     var inputs = midiAccess.inputs;
//     var outputs = midiAccess.outputs;
// }

// function onMIDIFailure() {
//     console.log('Could not access your MIDI devices.');
// }


const url = 'wss://exitpoints.herokuapp.com/8081'
const connection = new WebSocket(url)

connection.onopen = () => {
//   connection.send('hey')
}

let MIDITimingCount = 0
connection.onmessage = e => {
    let msg = JSON.parse(e.data)
    switch (msg.cmd){
        case "beat":
        document.getElementById("beat").innerHTML = msg.data
        // beat.textContent = msg.data

        // $("beat").update(msg.data);
        //console.log(msg.data)
        break;
        case "MIDI_Timing":
            document.getElementById("MIDITiming").innerHTML = MIDITimingCount++
        break
        case "bpm":
            document.getElementById("bpm").innerHTML = msg.data
        break
    }
}

</script>


</html>